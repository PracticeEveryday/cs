## four-way-Handshake
TCP는 연결 지향 프로토콜이라고 했다.   
three way handshake 보다 숫자 하나가 더 큰 four-way-Handshake 는 연결을 `해제` 할 때 진행되는 프로세스이다.

연결을 해제하는 것은 연결 되어 있는 두 노드 모두 시도할 수 있다.   
4-way handshake 를 진행하고 나면 두 노드가 사용하고 있던 리소스들이 정리되고 연결이 해제된다.

![image](https://github.com/user-attachments/assets/d473c1ea-de1b-4c97-998e-a4ce4d7db372)


1. 두 서버 모두 연결이 되어 있는 상태
   1. 연결을 종료하고 싶은 서버는 TCP Header에 FIN 플래그를 1로 활성화한다.
   2. 연결 종료를 시도한 서버의 소켓은 `FIN_WAIT_1`로 변경된다.
2. FIN 패킷을 받은 서버의 소켓은 `CLOSE_WAIT` 상태로 변경되고 `ACK`가 활성화된 패킷을 전송해준다.
3. ACK를 전달받은 서버는 `FIN_WAIT_2` 상태로 변경되고 다른 노드의 `FIN` 패킷을 기다린다.
4. 다른 서버가 `더 이상 보낼 데이터가 없다고 판단했을 때` `FIN 플래그가 설정된 패킷`을 클라이언트에게 보낸다.
5. `FIN`을 전달 받은 서버의 소켓은 `TIME_WAIT` 상태로 변경되고 `ACK` 패킷을 전송한다.
6. `ACK`를 전달 받은 서버의 소켓은 `CLOSED`로 변경된다.
7. 일정 시간이 경과된 뒤 소켓은 `CLOSED` 상태로 변경된다. 

### 🤔 왜 연결과 다른가?

✅ 연결 해제를 요청 받은 서버에서 보낼 데이터가 남아 있을 수 있기 떄문이다.

- A: 저기요 저 이제 연결 해제 하고 싶은데요?~~~ << FIN
- B: 네네 일단 알겠어요~ 우리가 보낼 게 없는 지 확인 한 번 해볼게요 기다려주세요 << ACK
- B: 음 이제 없네요 연결 끊어도 될 거 같아요 << FIN
- A: 네 알겠습니다 수고하셨습니다. 그래도 일정 시간까진 기다리고 있어 볼게요 << ACK

✅ 네트워크 지연으로 FIN을 보낸 것 보다 데이터가 늦게 도착할 수 있다.

- A: 저기요 저 이제 연결 해제 하고 싶은데요?~~~ << FIN + 
- A: 어머 마지막 데이터가 늦게 왔네요!


### 참고 자료
- [rfc793](https://datatracker.ietf.org/doc/html/rfc793)
- [TCP 4 way handshake 내용 정리](https://sjlim5092.tistory.com/37)