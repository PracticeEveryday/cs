## Handshake

컴퓨터에서 `Handshake`는 인증, 조정을 위해 사용되는 두 장치, 프로그램 간의 신호(signal)이다.   
네트워크 상에서 전체 통신이 시작되기 전 동신 링크의 `프로토콜 설정`을 교환하여 두 참가자 간의 자동화된 협상 프로세스이다.

일반적으로 `Handshake Process`는 서로 다른 장치 간 통신을 시도할 때 Protocol, 통신 규칙을 설정하기 위해 주고 받는 과정이다.   

Ex) 📌 예를 들어, 컴퓨터와 모뎀간 다른 장치가 통신할 때 스위키가 켜져 있음과 같은 준비가 되었음 + 사용 중인 프로토콜에 동의함을 Handshake 과정에서 나눈다.

간단한 Handshaking Protocol은 `마지막 메시지 잘 받았습니다. 다른 메시지 보낼 준비도 되었습니다.`로 끝낼 수도 있다.   
조금 더 복잡한 Handshaking Protocol은 `마지막 메시지를 제대로 받지 못했습니다.`와 같은 부정 승인도 보낼 수 있다.

Handshaking은 매개 변수들을 설정하기 위해 사람이 개입되지 않고 이질적인 시스템과 장비들을 쉽게 연결 할 수 있다.

> 모든 `Protocol`이 Handshake 라는 용어를 사용할까?
> 
> FTP, SMTP같은 프로토콜에는 Handshake라는 용어 대신 `conversation`이라는 용어를 사용한다고 한다.

### 3-way handshake

`three-way handshake`는 컴퓨터 네트워크 에서 TCP/IP 통신 Protocol을 사용하기 위해 연결을 설정하는 기본 프로세스이다.   
데이터 전송이 시작되기 전에 서버 간에 연결을 설정하기 위해 TCP(Transmission Control Protocol)에서 사용하는 프로세스이다.      
이 `three-way handshake`가 정상적으로 연결 되면 `통신 준비`가 완료 된다!

### Segment(조각)

Segment는 전송 계층에서 TCP 프로토콜을 활용할 떄 사용되는 데이터 단위이다.   
TCP는 상위 스트림에서 데이터를 받아 들여 청크로 나눈 뒤 `TCP 세그먼트`를 생성한다.   

> 프로세스는 TCP를 호출한 뒤 ➡️ 스트림 데이터를 매개변수로 전달한다.
> 
> TCP는 버퍼 데이터를 세그먼트로 패키징하고 Internet 모듈(IP)을 호출하고 각 세그먼트를 전송한다.

#### Segment 구조
`Segment`는 `헤더`와 `데이터` 섹션으로 구성된다.   

Segment Header는 10개의 필수 필드와 Optional의 확장 필드를 가진다.   
데이터 섹션은 Header Section 다음에 나오며 다른 App에 전달되는 데이터이다.

> Segment Header

![image](https://github.com/user-attachments/assets/d2e59bae-73a2-4ad1-b660-891381632f1f)

## TCP 헤더 필드 구성

1. **Source Port (16 bits)**
    - 발신지 포트 번호.

2. **Destination Port (16 bits)**
    - 수신지 포트 번호.

3. **Sequence Number (32 bits)**
    - 시퀀스 번호.
    - **SYN 플래그가 설정된 경우:**
        - 초기 시퀀스 번호.
    - **SYN 플래그가 설정되지 않은 경우:**
        - 현재 세션의 첫 번째 데이터 바이트의 누적 시퀀스 번호.

4. **Acknowledgement Number (32 bits)**
    - ACK 번호.
    - **ACK 플래그가 설정된 경우:**
        - 발신자가 예상하는 다음 시퀀스 번호.
        - 이전 바이트의 수신을 인정.

5. **Data Offset (4 bits)**
    - TCP 헤더의 길이를 32비트 워드 단위로 표시.

6. **Reserved (4 bits)**
    - 예약 필드. 현재는 0으로 설정.
    - 나중에 사용할 수 있도록 예약됨. 발신자는 이 필드를 설정할 수 없으며, 수신자는 특별한 지정이 없는 경우 무시함.

7. **Flags (8 bits)**
    - **CWR (1 bit):** 혼잡 윈도우 감소 신호.
    - **ECE (1 bit):** 혼잡 탐지 신호.
    - **URG (1 bit):** 긴급 여부.
    - **ACK (1 bit):** 승인 필드 (SYN 패킷 이후 모든 패킷에서 설정됨).
    - **PSH (1 bit):** 푸시 플래그.
    - **RST (1 bit):** 연결 재설정 여부.
    - **SYN (1 bit):** 시퀀스 번호 동기화 여부.
    - **FIN (1 bit):** 보낸 사람의 마지막 패킷 여부.

8. **Window Size (16 bits)**
    - 수신자가 수신할 수 있는 데이터의 크기.

9. **Checksum (16 bits)**
    - TCP 헤더와 페이로드의 오류 검사를 위한 필드.

10. **Urgent Pointer (16 bits)**
    - **URG 플래그가 설정된 경우:**
        - 긴급 데이터의 마지막 바이트를 나타내는 시퀀스 번호 오프셋.

11. **Options (0-320 bits, 32-bit 단위)**
    - 추가적인 옵션 필드. 필요에 따라 32비트 단위로 확장 가능.

### 참고 자료
- [Handshake](https://en.wikipedia.org/wiki/Handshake_(computing))
- [TCP](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)